
### TYPOLOGIE DES EXPLOITATIONS - NIAYES 2040

##### Fonctions

normaliz_zero<-function(x){
  
  min<-min(x)
  max<-max(x)
  
  val<-lapply(x,function(y) round((y-min)/(max-min),2))
  return(val)
}

#fonction de calcul des stats
stat.comp<-function(x,y){
  #nombre de groupes
  K <-length (unique(y))
  #nb. d'observations
  n <-length(x)
  #moyenne globale
  m <-mean(x)
  #variabilité totale
  TSS <-sum((x-m)^2)
  #effectifs conditionnels
  nk<-table(y)
  #moyennes conditionnelles
  mk<-tapply(x,y,mean)
  #variabilité expliquée
  BSS <-sum(nk*(mk-m)^2)
  #moyennes +prop . variance expliquée
  result<-c(mk,100.0*BSS/TSS)
  #nommer les élements du vecteur
  names(result)<-c( paste("G",1:K),"% epl.")
  #renvoyer le vecteur résultat
  return(result)
}

#fonction de calcul des stats
etendu_class<-function(x,y){
  
  #nombre de groupes
  K <-length (unique(y))
  #minimum maximum conditionnelles
  mink<-tapply(x,y,min)
  maxk<-tapply(x,y,max)
  #nommer les élements du vecteur
  p<-mink
  for (i in 1:length(names(maxk))){
    #u<-unite(p[i],mink[i], maxk[i], sep = "-")
    p[,i]<-(paste("[",round(mink[,i],2),";",round(maxk[,i],2),"]")) 
  }
  result<-p
  #renvoyer le vecteur résultat
  return(result)
}

#fonction intervalles
intvll<-function(x){
  maximun<-max(x)
  minimum<-min(x)
  intervalle<-(paste("[",round(minimum,2),",",round(maximun,2),"]",sep=""))
  
  x<-data.frame(x,maximun)
  x<-data.frame(x,minimum)
  x<-data.frame(x,intervalle)
  r<-unique(x["intervalle"])
  names(r)<-names(x)[1]
  return(r)}

#fonction intervalles par groupes
etendu_groupes<-function(x,y){
  K <-length (unique(y))
  result<-tapply(x,y,intvll)
  names(result)<-c( paste("G",1:K))
  #renvoyer le vecteur résultat
  return(result)
}

library(haven)
library(readxl)

kasse<-zap_labels(read_dta("data/Horticulture-Production-function.dta"))
papa <- read.csv2("data/donnees_papa_spatialisees.csv")
culture <- read_excel("data/cultures_End_May_31_sup.xlsx")

dc<-data.frame(kasse)

eau<-cbind(dc[,"producteur_ID"],
           dc[grepl("litre", names(dc),fixed=TRUE)],
           dc[grepl("eau", names(dc), fixed=TRUE)])

names(eau)[1]<-"producteur_ID"

num_dc<-dplyr::select_if(dc, is.numeric)

char_dc<-as.data.frame(unclass(dplyr::select_if(dc,
                                                is.character)),stringsAsFactors = TRUE)

eau<-aggregate(eau[-1],by = list(eau$producteur_ID),
               FUN = sum,na.rm=TRUE)

#data<-merge(papa, culture, by.x = "id", by.y = "ID")
#data<-data.frame(sapply(data,function(x) iconv(x, from = 'UTF-8', to = 'latin1')))

data<-data.frame(sapply(papa,function(x) iconv(x, from = 'UTF-8', to = 'latin1')))

qual<-c("id","ville","commune","site","relat_contract",
        "tracteur","source_eau","syst_exhaure_fin",
        "souscrit_assurance","source_energie_irrig_ssf",
        "source_energie_irrig_ssc","electricite",
        "systeme_arrosage","materiau_toit",
        "arrosage_group_enc","surf_score")

options(warn = -1)

data[,!(colnames(data) %in% qual)]<-data.frame(sapply(data[,
                                                           !(colnames(data) %in% qual)],as.numeric))

data[,(colnames(data) %in% qual)]<-data.frame(lapply(data[,
                                                          (colnames(data) %in% qual)],
                                                     function(x) as.factor(x)))

data<-merge(data, eau, by.x = "id", by.y = "Group.1")
data<-(data[,!(colnames(data) %in% Filter(function(x) grepl("moy", x), names(data)))])

data[,(colnames(data) %in% Filter(function(x) grepl("sup_", x), 
                                  names(data)))]<-data.frame(lapply((data[,(colnames(data) %in% 
                                                                              Filter(function(x) grepl("sup_", x),names(data)))]),
                                                                    function(x) ((x/data$suptotculm)*100)))
data[,(colnames(data) %in% Filter(function(x) grepl("sup_", x), 
                                  names(data)))]<-data.frame(lapply((data[,(colnames(data) %in% 
                                                                              Filter(function(x) grepl("sup_", x),names(data)))]),
                                                                    function(x) ((x/data$suptotculm)*100)))

x<-data[,(colnames(data) %in% Filter(function(x) grepl("moy", x),names(data)))]
x[is.na(x)]<-0

data[,(colnames(data) %in% Filter(function(x) grepl("moy", x),names(data)))]<-x

prod<-Filter(function(x) grepl("moy",x),names(data))

excl<-c(prod,'ville','commune','site','latitude','longitude',
        'ratiosuploue_tot','ratio_irr_tot','nb_boeufs_vendus',
        'rev_boeuf_vendus','rev_volaille','rev_mouton',
        'revenu_elevage_total','revenu_ag_tot','rev_ag_csf',
        'rev_ag_csc','rev_transfert','rev_non_ag',
        'materiau_toit','source_energie_irrig_ssf',
        'systeme_arrosage','source_energie_irrig_ssc',
        'cout_irigation_ssf','cout_irigation_ssc',
        'cout_irrig_tot_ha','main_oeuvre_fam_tot',
        'main_oeuvre_sal_tot','mo_tot_ha','cout_npk_tot',
        'cout_uree_tot','cout_engrais_tot',
        'quantite_npk_tot_ha','quantite_uree_tot_ha',
        'cout_uree_tot_ha','cout_npk_tot_ha',"dist_dakar",
        'cout_engrais_tot_ha','cout_intrants_tot',
        'cout_intrants_tot_ha','cout_semence_tot_ha',
        'part_cout_sem','part_cout_engr','travailleurs_fam',
        'surf_score','y_hat','y_mean','sse_i','sst_i',
        'ss_bis','credit','capital','nbre_litre_carburant_csf',
        'lnprod','quant_litre_csf_mois','quant_litre_csc_mois',
        'quant_litre_csf_jour','eau_culture_csc','quant_eau_csf',
        'quant_eau_csc','eau_culture_csf',"log_trav_ha",
        'nbre_litre_carburant_csc','quant_litre_csc_jour',
        'besoin_eau_culture',"besoin_eau_reel")

df<-(data[,!(colnames(data) %in% excl)])

df <- df[!unlist(lapply(df,
                        function(x) length(unique(x))==1))]

df <- data.frame(df[,-1], row.names = df[,1])
##### retour aux données initiales
write.csv2(data,file.path(getwd(),"data.csv"))
#library(FactoMineR)
#library(missMDA)
library(VIM,quietly = TRUE)

missr<-summary(aggr(df, sortVar=TRUE))$combinations
too_missing<-c("")

del<-which(names(data)%in%c(""))
df<-data[,-c(del)]

df<-na.omit(df)
df<-data.frame(df, row.names = 1)
xquant<-dplyr::select_if(df, is.numeric)

xqual<-as.data.frame(unclass(dplyr::select_if(df,
                                              is.factor)),stringsAsFactors = TRUE)

df["tracteur"]<-(droplevels(df["tracteur"]))

summary(df)
hist(df$suptotculmen)
hist(df$suptotculmen*10000)
hist(log(df$suptotculmen*10000))hist(df$cout_semence_tot)
hist(df$cout_semence_tot/(df$suptotculmen*10000))
hist(log(df$cout_semence_tot/(df$suptotculmen*10000)))hist((df$part_rev_non_ag_tot))
hist(log(df$part_rev_non_ag_tot))hist((df$taille_men))
hist(log(df$taille_men))hist((df$part_rev_ag_tot))
hist(log(df$part_rev_ag_tot))
mtsup<-xquant
mcor <- cor(mtsup)
library(corrplot)
corrplot(mcor, type="upper", order="hclust", 
         tl.col="black", tl.srt=45)

library(tidyverse)
library(ggpubr)

res.cor <- cor(xquant, method = "spearman")
mds.cor <- (1 - res.cor) %>%
  cmdscale() %>%
  as_tibble()
colnames(mds.cor) <- c("Dim.1", "Dim.2")
ggscatter(mds.cor, x = "Dim.1", y = "Dim.2", 
          size = 1,
          label = colnames(res.cor),
          repel = TRUE)

require(zoo)
datz <- zoo(xquant)

plot(datz)

library("clusterSim")
library("psych")
library("MASS")
library("kmed")

tp<-c()
for (i in 1:length(names(df))){
  if (is.numeric(df[,i])){
    tp[i]<-"num"
  }else{
    if (length(levels(df[,i]))>2){
      tp[i]<-"cat"
    }else{tp[i]<-"bin"}
  }
}

bin<-which(tp=="bin")
num<-which(tp=="num")
cat<-which(tp=="cat")

d1<-df
#rownames(d1) <- NULL

dist.df <- distmix(d1, method = "gower", idnum = num, idbin = bin,
                   idcat = cat)

mds1 <- cmdscale(dist.df, k=9)

plot(mds1)

abline(v=0.2)
abline(h=0.2)

abline(v=-0.2)
abline(h=-0.2)

x1.out<-which(abs(mds1[,1])>0.2)
y1.out<-which(abs(mds1[,2])>0.2)

out1.all<-c(x1.out, y1.out)
out1.uni<-unique(out1.all)
D1<-d1[out1.uni,]

D1$x1.out<-mds1[out1.uni,1]
D1$y1.out<-mds1[out1.uni,2]
points(D1[,c("x1.out","y1.out")],
       pch=21, bg="red")

# Nonmetric MDS
# N rows (objects) x p columns (variables)
# each row identified by a unique row name

dist1.df <- distmix(d1, method = "gower", idnum = num, idbin = bin,
                    idcat = cat) # distance matrix for a mixed data
fit <- isoMDS(dist1.df, k=3) # k is the number of dim
#fit # view results

# plot solution
x <- fit$points[,1]
y <- fit$points[,2]
z <- fit$points[,3]

plot(x, y, xlab="Coordinate 1", ylab="Coordinate 2",
     main="Nonmetric MDS1", type="n")
text(x, y, labels = row.names(df), cex=.7) 

plot(y, z, xlab="Coordinate 2", ylab="Coordinate 3",
     main="Nonmetric MDS2", type="n")
text(y, z, labels = row.names(df), cex=.7) 


plot(x, z, xlab="Coordinate 1", ylab="Coordinate 3",
     main="Nonmetric MDS3", type="n")

text(x, z, labels = row.names(df), cex=.7) 

dist1.df <- distmix(d1, method = "gower", idnum = num, idbin = bin,
                    idcat = cat) # distance matrix for a mixed data
fit <- isoMDS(dist1.df, k=2) # k is the number of dim
#fit # view results

plot(fit$points)

abline(v=0.2)
abline(h=0.2)

abline(v=-0.2)
abline(h=-0.2)

x.out<-which(abs(fit$points[,1])>0.2)
y.out<-which(abs(fit$points[,2])>0.2)

out.all<-c(x.out, y.out)
out.uni<-unique(out.all)

D<-data.frame(d1[out.uni,])
D$x.out<-unlist(fit$points[out.uni,1])
D$y.out<-unlist(fit$points[out.uni,2])

points(D[,c("x.out","y.out")],
       pch=21, bg="red")

row.names(d1[out1.uni,])
row.names(d1[out.uni,])

dist.au<-dist1.df
city.names<-row.names(d1)

library(igraph)
g <- graph.full(nrow(dist.au))
V(g)$label <- city.names
layout <- layout.mds(g, dist = as.matrix(dist.au))
plot(g, layout = layout, vertex.size = 3)
outl<-unique(c("2133","1789","2169","2690","2796","2011","2379","2052","2407","2774",'1817','2011',
               '2169','2190','2193','2606','2690','2691','2726','2133','2169','2052','2300'))# Model Based Clustering
library(mclust)
fit <- Mclust(d1)
plot(fit) # plot results
summary(fit) # display the best model 
base<-df
#base<-df[which(df$suptotculmen>0.4),]
#base<-df[which(row.names(df)!=outl),]

dim(base)

#264-251=13
base$suptotculmen<-(base$suptotculmen*10000)
for (i in names(base[,(colnames(base) %in% qual)])){
  
  base[,i]<-sub("^",
                paste(i,"=",sep=""),base[,i])
}
for (i in names(base[,!(colnames(base) %in% qual)])){
  
  base[i]<-log(base[i]+1)
}
to_ratio<-c('cout_irrig_tot','mo_tot','quantite_npk_tot',
            'quantite_uree_tot','cout_semence_tot',
            'besoin_eau_total')


for (i in to_ratio){
  
  base[i]<-(base[i]/base['suptotculmen'])
}

to_ratio_men<-c('personne_migr','membre_actifs',
                'membre_hors_exploi')


for (i in to_ratio_men){
  
  base[i]<-(base[i]/base['taille_men'])
}

to_norm<-c('rev_tot_menage','part_rev_ele_tot',
           'part_rev_transf_tot','part_rev_non_ag_tot',
           'montan_global_credit','dist_route','pourc_urbain',
           to_ratio_men,to_ratio)

base$suptotculmen<-log(base$suptotculmen)

for (i in to_norm){
  base[i]<-log(base[i]+1)
}

bn<-dplyr::select_if(base, is.numeric)
boxplot(bn,col = rainbow(ncol(bn)))

library(quantable)

for (i in names(base[,!(colnames(base) %in% qual)])){
  
  base[i]<-as.numeric(scale(base[i], 
                            center = TRUE,
                            scale = TRUE))
}
for (i in names(base[,!(colnames(base) %in% qual)])){
  
  base[i]<-as.numeric(robustscale(base[i], 
                                  center = TRUE,
                                  scale = TRUE))
}scale_iqr=function(x){
  q<-quantile(x)
  med<-median(x)
  (x-med)/(q[2]-q[4])
}

for (i in names(base[,!(colnames(base) %in% qual)])){
  
  base[,i]<-scale_iqr(base[,i])
}scale_mia=function(x){
  mi<-min(x)
  ma<-max(x)
  (x-mi)/(ma-mi)
}

for (i in names(base[,!(colnames(base) %in% qual)])){
  
  base[,i]<-scale_mia(base[,i])
}
bn1<-dplyr::select_if(base, is.numeric)
boxplot(bn1,col = rainbow(ncol(bn1)))

mcor2 <- cor(bn1)
library(corrplot)
corrplot(mcor2, type="upper", order="hclust", 
         tl.col="black", tl.srt=45)

library(tidyverse)
library(ggpubr)

res.cor1 <- cor(bn1, method = "spearman")
mds.cor1 <- (1 - res.cor) %>%
  cmdscale() %>%
  as_tibble()
colnames(mds.cor1) <- c("Dim.1", "Dim.2")
ggscatter(mds.cor1, x = "Dim.1", y = "Dim.2", 
          size = 1,
          label = colnames(res.cor1),
          repel = TRUE)
##### retour aux données initiales
write.csv2(base,file.path(getwd(),"base.csv"))
stop!
  
  library("FactoMineR")
library("factoextra")
Factoshiny::Factoshiny(base)
res.famd <- FAMD(base, graph = FALSE,ncp=33)
fviz_screeplot(res.famd,addlabels = TRUE)

eig.val <- get_eigenvalue(res.famd)
#eig.val
head(eig.val,10)

res.famd <- FAMD(base, graph = FALSE,ncp = 5)

quanti.var <- get_famd_var(res.famd, "quanti.var")
quali.var <- get_famd_var(res.famd, "quali.var")

# Graphique des variables
fviz_famd_var(res.famd, col.var="cos2", alpha.var="contrib",
              gradient.cols = c("blue", "green", "red"), repel = TRUE)

# Graphique des variables
fviz_famd_var(res.famd, col.var="cos2", alpha.var="contrib",
              gradient.cols = c("blue", "green", "red"), 
              repel = TRUE,axes=c(2,3))

# Graphique des variables
fviz_famd_var(res.famd, col.var="cos2", alpha.var="contrib",
              gradient.cols = c("blue", "green", "red"),
              repel = TRUE,axes=c(3,4))

# Graphique des variables
fviz_famd_var(res.famd, col.var="cos2", alpha.var="contrib",
              gradient.cols = c("blue", "green", "red"),
              repel = TRUE,axes=c(4,5))

fviz_famd_var(res.famd, "quanti.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
              repel = TRUE)

fviz_famd_var(res.famd, "quanti.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
              repel = TRUE,axes=c(2,3))

fviz_famd_var(res.famd, "quanti.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
              repel = TRUE,axes=c(3,4))

fviz_famd_var(res.famd, "quanti.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
              repel = TRUE,axes=c(4,5))

fviz_famd_var(res.famd, "quali.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")
)

fviz_famd_var(res.famd, "quali.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800",
                                "#FC4E07"),axes=c(2,3)
)

fviz_famd_var(res.famd, "quali.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800",
                                "#FC4E07"),axes=c(3,4)
)

fviz_famd_var(res.famd, "quali.var", col.var = "contrib", 
              gradient.cols = c("#00AFBB", "#E7B800",
                                "#FC4E07"),axes=c(4,5)
)

fviz_pca_ind(res.famd, col.ind = "cos2", 
             gradient.cols = c("#00AFBB",
                               "#E7B800", "#FC4E07"),
             repel = TRUE)

fviz_pca_ind(res.famd, col.ind = "cos2", 
             gradient.cols = c("#00AFBB",
                               "#E7B800", "#FC4E07"),
             repel = TRUE,axes=c(2,3))

fviz_pca_ind(res.famd, col.ind = "cos2", 
             gradient.cols = c("#00AFBB",
                               "#E7B800", "#FC4E07"),
             repel = TRUE,axes=c(3,4))

fviz_mfa_ind(res.famd, 
             habillage = "arrosage_group_enc", # color by groups 
             palette = 1:4,repel = TRUE, # Avoid text overlapping
) 

fviz_mfa_ind(res.famd, 
             habillage = "arrosage_group_enc", # color by groups 
             palette = 1:4,repel = TRUE, # Avoid text overlapping
             axes=c(2,3)) 

fviz_mfa_ind(res.famd, 
             habillage = "arrosage_group_enc", # color by groups 
             palette = 1:4,repel = TRUE, # Avoid text overlapping
             ,axes=c(3,4)) 

# classification
hc.famd <- HCPC(res.famd, graph = FALSE) #Si nb.clust = -1 : laisser le programme décider du nombre optimal de clusters.

fviz_dend(hc.famd, 
          cex = 0.7,                     # Label size
          palette = "jco",               # Color palette see ?ggpubr::ggpar
          rect = TRUE, rect_fill = TRUE, # Add rectangle around groups
          rect_border = "jco",           # Rectangle color
          labels_track_height = 0.8      # Augment the room for labels
)

fviz_cluster(hc.famd,
             repel = TRUE,            # Avoid label overlapping
             show.clust.cent = TRUE, # Show cluster centers
             palette = "jco",         # Color palette see ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
)

# Principal components + tree
plot(hc.famd, choice = "3D.map")

hc.famd$desc.var$quanti

hc.famd$desc.axes$quanti

hc.famd$desc.ind$para

# Description by variables
hc.famd$desc.var$test.chi2

# Description by variable categories
hc.famd$desc.var$category

df.clust<-df
base.clust<-base

df.clust$clust<-hc.famd$data.clust$clust
base.clust$clust<-hc.famd$data.clust$clust

stat_clust<-data.frame(sapply(df.clust[(names(df.clust)%in%names(xquant))],stat.comp ,y=df.clust$clust))
stat_clust<-round(stat_clust,2)
t(stat_clust)
for (i in names(xqual)){
  
  gmodels::CrossTable(unlist(df.clust[i]), 
                      unlist(df.clust["clust"]), 
                      prop.t=T,prop.r=F, 
                      prop.c=F,prop.chisq=F,
                      fisher=T,chisq=T)
}


# Load the library
library(randomForest)
library(data.table)
library(caret)

set.seed(123)
# Create random forest
# For classification
base.clust.rf <- randomForest(clust ~ ., 
                              data = base.clust, 
                              importance = TRUE,
                              proximity = TRUE)

print(base.clust.rf)
plot(base.clust.rf)

varImpPlot(base.clust.rf,type=1)

gmodels::CrossTable(unlist(df.clust$tracteur), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.clust$relat_contract), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.clust$source_eau), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.clust$syst_exhaure_fin), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.clust$souscrit_assurance), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.clust$electricite), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.clust$arrosage_group_enc), 
                    unlist(df.clust$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

varImp(base.clust.rf)

library(tidyverse)
library(caret)
library(glmnet)

# Dumy code categorical predictor variables
x <- model.matrix(clust~., base.clust)[,-1]

y=base.clust$clust

fit <- glmnet(x, y, family = "multinomial", type.multinomial = "grouped")
plot(fit, xvar = "lambda", label = TRUE, type.coef = "2norm")

set.seed(123)
cvfit <- cv.glmnet(x, y, family = "multinomial", type.multinomial = "grouped")
plot(cvfit)

coef(cvfit, cvfit$lambda.1se)

l<-coef(cvfit, cvfit$lambda.1se)
cd<-c()
for (i in 1:4){
  
  d<-data.frame(Reduce(rbind, l[[i]]))
  d[,2]<-rownames(l[[i]])
  names(d)<-c("coef","variables")
  rownames(d)<-NULL
  cd<-unique(c(cd,d[which(d$coef!=0),]$variables))[-1]
}
cd

sw<-distmix(base, method = "gower", idnum = num, idbin = bin,
            idcat = cat)
# Load required packages
library(magrittr)
library(dplyr)
library(ggpubr)

# Cmpute MDS
mds <- sw %>%         
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = rownames(sw),
          size = 1,
          repel = TRUE)
library(magrittr)
library(dplyr)
library(ggpubr)
# Cmpute MDS
library(MASS)
mds <- sw %>%        
  isoMDS() %>%
  .$points %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")
# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = rownames(sw),
          size = 1,
          repel = TRUE)
# Cmpute MDS
library(MASS)
mds <- sw %>%         
  sammon() %>%
  .$points %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")
# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = rownames(sw),
          size = 1,
          repel = TRUE)

fviz_nbclust(mds, FUNcluster = cluster::pam, 
             method = c("silhouette"))

fviz_nbclust(mds, kmeans, method = c("silhouette"))

# K-means clustering
clust <- kmeans(mds, 4)$cluster %>%
  as.factor() 

mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = rownames(sw),
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)

df.sammon<-df
df.sammon$clust<-clust

stat_clust1<-data.frame(sapply(df.sammon[(names(df.sammon)%in%names(xquant))],
                               stat.comp ,y=df.sammon$clust))

stat_clust1<-round(stat_clust1,2)
t(stat_clust1)

df.sammon.rf <- randomForest(clust ~ ., 
                             data = df.sammon, 
                             importance = TRUE,
                             proximity = TRUE)

varImpPlot(df.sammon.rf,type=1)

gmodels::CrossTable(unlist(df.sammon$tracteur), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.sammon$relat_contract), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.sammon$source_eau), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.sammon$syst_exhaure_fin), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.sammon$souscrit_assurance), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.sammon$electricite), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(df.sammon$arrosage_group_enc), 
                    unlist(df.sammon$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

imp_df.sammon<-setDT(varImp(df.sammon.rf), keep.rownames = TRUE)[]
imp_df.sammon

var<-c("id",'suptotculmen','rev_tot_menage','cout_intrants_tot',
       'ratiosuploue_tot','ratio_irr_tot','nb_boeufs_vendus',
       'personne_migr','rev_non_ag','montan_global_credit',
       'rev_transfert','part_mo_fam','cout_semence_tot',
       "besoin_eau_total")

df.cam<-(data[,(colnames(data) %in% var)])
#df.cam<-df.cam[which(row.names(df)!=outl),]
df.cam <- data.frame(df.cam[,-1], row.names = df.cam[,1])
for (i in names(df.cam)){
  
  df.cam[i]<-as.numeric(scale(df.cam[i], 
                              center = TRUE,
                              scale = TRUE))
}
X<-cbind(df.cam,xqual)
pca_cam <- PCA(X,graph=FALSE,quali.sup=which(names(X)%in%names(xqual)))
pca_var_cam <- get_pca_var(pca_cam)

fviz_screeplot(pca_cam,addlabels = TRUE)

eig.val.pca <- get_eigenvalue(pca_cam)
#eig.val
head(eig.val.pca,3)

pca_cam <- PCA(df.cam, graph = FALSE,ncp = 3)

fviz_pca_var(pca_cam, col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

fviz_pca_ind(pca_cam, col.ind = "cos2", 
             gradient.cols = c("#00AFBB",
                               "#E7B800", "#FC4E07"),
             repel = TRUE)

res.hcpc.pca <- HCPC(pca_cam, graph = FALSE)
fviz_dend(res.hcpc.pca, 
          cex = 0.7,                     # Taille du text
          palette = "jco",               # Palette de couleur ?ggpubr::ggpar
          rect = TRUE, rect_fill = TRUE, # Rectangle autour des groupes
          rect_border = "jco",           # Couleur du rectangle
          labels_track_height = 0.8      # Augment l'espace pour le texte
)

fviz_cluster(res.hcpc.pca,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = TRUE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
)

# Principal components + tree
plot(res.hcpc.pca, choice = "3D.map")

res.hcpc.pca$desc.ind

res.hcpc.pca$desc.var$quanti

cam.pca.clt<-X
cam.pca.clt$cluster<-res.hcpc.pca$data.clust$clust

cam.pca.rf <- randomForest(cluster ~ ., 
                           data = na.omit(cam.pca.clt), 
                           importance = TRUE,
                           proximity = TRUE)

varImpPlot(cam.pca.rf,type=1)



library(factoextra)
library(FactoMineR)

famd <- FAMD(base,graph=FALSE,ncp=33)
famdvar <- get_famd_var(famd)

fviz_famd_var(famd, col.var="cos2", alpha.var="contrib", gradient.cols = c("blue", "green", "red"), repel = TRUE)

fviz_screeplot(famd,addlabels = TRUE)

famd <- FAMD(base,graph=FALSE,ncp=6)

library(clustertend)
datafamd <- data.frame(res.famd$ind$coord)
hopkins(datafamd, n=100)

get_clust_tendency(datafamd, 2, graph=F, gradient=list(low="red", mid="white", high="blue"))$hopkins_stat

fviz_nbclust(datafamd , FUNcluster = cluster::pam, method = c("silhouette"), k.max = 8, nboot = 100,)

set.seed(123)
pam8 <- eclust(datafamd, "pam", hc_metric="euclidean", k=4)

fviz_silhouette(pam8)

clt<-data.frame(as.factor(pam8$clustering))
names(clt)<-"cluster"
clt<-merge(df,clt, by = 0)
clt<-data.frame(clt, row.names = 1)

library(tidyverse)
library(caret)
library(glmnet)

# Dumy code categorical predictor variables
x <- model.matrix(cluster~., clt)[,-1]

y=clt$clust

fit <- glmnet(x, y, family = "multinomial", type.multinomial = "grouped")
plot(fit, xvar = "lambda", label = TRUE, type.coef = "2norm")
fit <- glmnet(x, y, family = "multinomial", type.multinomial = "grouped")
plot(fit, xvar = "lambda", label = TRUE,alpha=0.8)
set.seed(123)
cvfit <- cv.glmnet(x, y, family = "multinomial", type.multinomial = "grouped")
plot(cvfit)

coef(cvfit, cvfit$lambda.1se)

l<-coef(cvfit, cvfit$lambda.1se)
cd<-c()
for (i in 1:4){
  
  d<-data.frame(Reduce(rbind, l[[i]]))
  d[,2]<-rownames(l[[i]])
  names(d)<-c("coef","variables")
  rownames(d)<-NULL
  cd<-unique(c(cd,d[which(d$coef!=0),]$variables))[-1]
}
cd

df_num<-dplyr::select_if(df, is.numeric)

df_char<-as.data.frame(unclass(dplyr::select_if(df,
                                                is.factor)),stringsAsFactors = TRUE)

new_xquant<-df_num[(colnames(df_num) %in% cd)]
new_xqual<-df_char

library(cluster)
gow_data<-cbind(new_xquant,new_xqual)
d <- daisy(gow_data, metric="gower")

d.mat<-data.frame(as.matrix(d))

fviz_nbclust(d.mat, FUNcluster = cluster::pam, 
             method = c("silhouette"))

fviz_nbclust(d.mat, FUNcluster = kmeans, 
             method = c("silhouette"))

fit <- hclust(d=d, method="complete")    # Also try: method="ward.D"   
plot.new()
plot(fit, hang=-1)  

# K-means clustering
clust <- kmeans(mds, 5)$cluster %>%
  as.factor() 

mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = rownames(sw),
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)

library(JLutils)
best.cutree(fit, graph = TRUE, xlab = "Nombre de classes", ylab = "Inertie relative")

kfit <- kmeans(d, 3)
clusplot(as.matrix(d), kfit$cluster, color=T, shade=T, labels=2, lines=0)

questionr::freq(kfit$cluster)

gow_data$cluster<-kfit$cluster

# Load the library
library(randomForest)

set.seed(123)
# Create random forest
# For classification
gd.rf <- randomForest(cluster ~ ., 
                      data = gow_data, 
                      importance = TRUE,
                      proximity = TRUE)

print(gd.rf)
plot(gd.rf)

varImpPlot(gd.rf,type=1)

library(data.table)
imp<-setDT(varImp(gd.rf), keep.rownames = TRUE)[]
imp<-(imp[order(imp$Overall,decreasing = TRUE),])
imp

sapply(gow_data[(names(gow_data)%in%names(new_xquant))],quantile)

x<-data.frame(sapply(gow_data[(names(gow_data)%in%names(new_xquant))],stat.comp ,y =gow_data$cluster))
x<-round(x,2)
t(x)

q<-data.frame(lapply(gow_data[(names(gow_data)%in%names(new_xqual))],function(x) as.factor(x)))

# Remove college name before clustering
gower_dist <- daisy(gow_data,
                    metric = "gower",
                    type = list(logratio = 3))

gower_mat <- as.matrix(gower_dist)
# Output most similar pair
gow_data[
  which(gower_mat == min(gower_mat[gower_mat != min(gower_mat)]),
        arr.ind = TRUE)[1, ], ]

# Output most dissimilar pair
gow_data[
  which(gower_mat == max(gower_mat[gower_mat != max(gower_mat)]),
        arr.ind = TRUE)[1, ], ]

# Calculate silhouette width for many k using PAM

sil_width <- c(NA)

for(i in 2:10){
  
  pam_fit <- pam(gower_dist,
                 diss = TRUE,
                 k = i)
  
  sil_width[i] <- pam_fit$silinfo$avg.width
  
}

# Plot sihouette width (higher is better)

plot(1:10, sil_width,
     xlab = "Number of clusters",
     ylab = "Silhouette Width")
lines(1:10, sil_width)

pam_fit <- pam(gower_dist, diss = TRUE, k = 4)

pam_results <- gow_data %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))

pam_results$the_summary

library(Rtsne)
tsne_obj <- Rtsne(gower_dist, is_distance = TRUE)

tsne_data <- tsne_obj$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(pam_fit$clustering),
         name = rownames(gow_data))

ggplot(aes(x = X, y = Y), data = tsne_data) +
  geom_point(aes(color = cluster))

##### retour aux données initiales
clust.data.gow<-left_join(gow_data %>%
                            mutate(name = rownames(gow_data)),
                          tsne_data,by = 'name')
rownames(clust.data.gow)<-rownames(gow_data)

questionr::freq(tsne_data$cluster)

clust.data.gow$cluster

library(Hmisc)

for (i in 1:3){
  o<-gow_data[which((gow_data["cluster"]==i)),
              (names(gow_data)%in%names(new_xqual))]
  
  o<-data.frame(lapply(o,function(x) as.factor(x)))
  
  print(i)
  print(Hmisc::describe(o))
}







library(ClustOfVar)

xquant1<-dplyr::select_if(base, is.numeric)

xqual1<-as.data.frame(unclass(dplyr::select_if(df,
                                               is.factor)),stringsAsFactors = TRUE)

for (i in names(xqual1)){
  
  xqual1[,i]<-sub("^",
                  paste(i,"=",sep=""),xqual1[,i])
}

X.quanti <- PCAmixdata::splitmix(base)$X.quanti
X.quali <- PCAmixdata::splitmix(base)$X.quali
tree <- hclustvar(X.quanti,X.quali)

#tree <- hclustvar(xquant1, xqual1)
plot(tree)
plot(tree,type="index")

set.seed(123)


part_init<-cutreevar(tree,5)$cluster

k_var.means <- kmeansvar(xquant1, xqual1,
                         init=part_init,
)
summary(k_var.means)

k_var.means

synt_var<-k_var.means$scores
head(synt_var,4)

library("factoextra")

fviz_nbclust(synt_var, kmeans, method = "wss")

fviz_nbclust(synt_var, FUNcluster = kmeans, 
             method = c("silhouette"))

kmeans(synt_var, centers = 4, nstart = 25)
d <- daisy(synt_var, metric="gower")
dmt<-as.matrix(d)
#plot results of final k-means model
k4<-kmeans(synt_var, centers = 4, nstart = 25)
fviz_cluster(k4,data = synt_var)
questionr::freq(k4$cluster)

dtc<-data.frame(synt_var)
dtc$cluster<-k4$cluster
centre<-data.frame(k4$centers)

for (i in 1:dim(dtc)[1]){
  
  for (j in 1:4){
    if(dtc[i,"cluster"]==j){
      dtc[i,"dist_centroid"]<-dist(rbind(dtc[i,1:5],centre[j,]))[1]
    }
  }
}
library(dplyr) 
X<-dtc
X$id<-row.names(X)
para<-X %>% 
  group_by(cluster) %>% 
  slice(which.min(dist_centroid))

para <- data.frame(para[,-8], row.names = para$id)
para[,c("cluster","dist_centroid")]

X<-dtc
X$id<-row.names(X)
para<-X %>% 
  group_by(cluster) %>% 
  arrange(dist_centroid) %>%
  slice_head(n=4)

para <- data.frame(para[,-8], row.names = para$id)
para[,c("cluster","dist_centroid")]

library(randomForest)

var_clt4<-cbind(xquant, xqual)
var_clt4$cluster<-k4$cluster

set.seed(123)
# Create random forest
# For classification
var.rf4 <- randomForest(cluster ~ ., 
                        data = var_clt4, 
                        importance = TRUE,
                        proximity = TRUE)
print(var.rf4)

varImpPlot(var.rf4,type=1)

library(randomForest)

v<-data.frame(synt_var)
v$cluster<-k4$cluster
names(v)<-c("capital","diversification","isolement",
            "travail","moyen_de_production","cluster")

set.seed(123)
# Create random forest
# For classification
v.rf4 <- randomForest(cluster ~ ., 
                      data = v, 
                      importance = TRUE,
                      proximity = TRUE)
print(v.rf4)

varImpPlot(v.rf4,type=1)

var_clt4

k4$centers
synt_var[which(synt_var$cluster1==k4$centers$cluster1 &
                 synt_var$cluster2==k4$centers$cluster2 &
                 synt_var$cluster3==k4$centers$cluster3 &
                 synt_var$cluster4==k4$centers$cluster4 &
                 synt_var$cluster5==k4$centers$cluster5),]
x_var4<-data.frame(sapply(var_clt4[(names(var_clt4)%in%(names(xquant)))],
                          stat.comp ,y =var_clt4$cluster))

x_var4<-round(x_var4,2)
t(x_var4)

gmodels::CrossTable(unlist(var_clt4$tracteur), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(var_clt4$relat_contract), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(var_clt4$source_eau), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(var_clt4$syst_exhaure_fin), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(var_clt4$souscrit_assurance), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(var_clt4$electricite), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)

gmodels::CrossTable(unlist(var_clt4$arrosage_group_enc), 
                    unlist(var_clt4$clust), 
                    prop.t=T,prop.r=F, 
                    prop.c=F,prop.chisq=F,
                    fisher=T,chisq=T)
var1 = Superficie emblavee (ha)
var2 = Quantite d’eau saison froide
var3 = Quantite d’eau saison chaude
var4 = Quantite de semences (en kg)
var5 = Quantite d’uree (em kg)
var6 = Quantite de NPK (kg)
var 7 = capital
var1.7<-c("producteur_ID","saison",
          "culture_label","var1","var4",
          "var5","var6","quant_eau_csc",
          "quant_eau_csf","var7",
          "eau_culture_csf","eau_culture_csc")

datt<-kasse[var1.7]

datt<-dplyr::left_join(datt,
                       var_clt4[c("cluster","suptotculmen")] %>%
                         mutate(producteur_ID = 
                                  as.numeric(rownames(var_clt4["cluster"]))),
                       by = 'producteur_ID')

datt<-dplyr::left_join(datt,
                       data[c("capital","id")] %>%
                         mutate(producteur_ID =
                                  as.numeric(as.character(data$id))),
                       by = 'producteur_ID')

names(datt)[which(names(datt)=="capital")]<-"capital_spatialise"

datt$quant_eau<-ifelse(datt$saison=='CSC',datt$quant_eau_csc,datt$quant_eau_csf)
datt$eau_culture<-ifelse(datt$saison=='CSC',datt$eau_culture_csc,datt$eau_culture_csf)

names(datt)[which(var1.7=="var1"|
                    var1.7=="var4"|
                    var1.7=="var5"|
                    var1.7=="var6"|
                    var1.7=="var7")]<-
  c("sup_emblavee_ha","quant_semence_kg",
    "quant_uree_kg","quant_npk_kg",
    "capital")

datt$saison<-gsub(" ","_",tolower(datt$saison))

datt$culture_label<-gsub(" ","_",
                         tolower(datt$culture_label))

datt<-datt[-which(names(datt)=='quant_eau_csc'|
                    names(datt)=='quant_eau_csf'|
                    names(datt)=="eau_culture_csf"|
                    names(datt)=="eau_culture_csc")]

datt<-na.omit(datt)
datt<-datt[-which(names(datt)=='id')]

datt$cumul_superficie<-ave(datt$sup_emblavee_ha,
                           datt$producteur_ID,
                           datt$saison,FUN=sum)

datt$surf_verger<-datt$suptotculmen-datt$cumul_superficie

datt<-datt[-which(datt$culture_label=='aubergine_douce'),]

datt$culture_label<-gsub("carrotte","carotte",
                         datt$culture_label)

datt$cumul_superficie<-ave(datt$sup_emblavee_ha,
                           datt$producteur_ID,
                           datt$saison,FUN=sum)

datt$pourcent_emblavee<-(datt$sup_emblavee_ha/datt$cumul_superficie)*100

datt[4:length(names(datt))]<-round(datt[4:length(names(datt))],2)

sc<-datt$suptotculmen
se<-datt$sup_emblavee_ha
cs<-datt$cumul_superficie
vg<-datt$surf_verger

datt$sup_non_ajust<-datt$sup_emblavee_ha
datt$sup_emblavee_ha<-round(sc*(se/(cs+vg)),2)

arch_data<-"archives/BASE  HORTICULTURE NIAYES VALLLEE-CLEAN"

var<-c("producteur_ID","culture_label",
       "saison","production_kg")

rendement_cult<-zap_labels(read_dta(file.path(arch_data,
                                              "vf_8_Production.dta")))[var]

rendement_cult$saison<-gsub(" ","_",tolower(rendement_cult$saison))
rendement_cult$culture_label<-gsub(" ","_",
                                   tolower(rendement_cult$culture_label))

rendement_cult$culture_label<-gsub("carrotte","carotte",
                                   rendement_cult$culture_label)

var<-c("producteur_ID","culture_label","saison",
       "prix_kg_seed")

cout_semence<-zap_labels(read_dta(file.path(arch_data,
                                            "vf_9_semence.dta")))[var]

cout_semence<-na.omit(cout_semence)

cout_semence<-aggregate(cout_semence["prix_kg_seed"],
                        FUN = sum,by = list(cout_semence$producteur_ID,
                                            cout_semence$saison,
                                            cout_semence$culture_label))

names(cout_semence)<-c("producteur_ID","culture_label",
                       "saison","prix_kg_semence")

cout_semence$saison<-gsub(" ","_",tolower(cout_semence$saison))
cout_semence$culture_label<-gsub(" ","_",
                                 tolower(cout_semence$culture_label))

cout_semence$culture_label<-gsub("carrotte","carotte",
                                 cout_semence$culture_label)

var<-c("producteur_ID","cultures_csf","cout_eau_csc",
       "cout_carburant_csc","cout_electricite_csc")

cout_electric<-zap_labels(read_dta(file.path(arch_data,
                                             "vf_0_producteur_id.dta")))[var]

names(cout_electric)<-c("producteur_ID","culture_label",
                        "cout_eau_irrig","cout_carbur_irrig",
                        "cout_elect_irrig")

cout_electric$culture_label<-gsub(" ","_",
                                  tolower(cout_electric$culture_label))

cout_electric$culture_label<-gsub("carrotte","carotte",
                                  cout_electric$culture_label)

npk<-read.csv2(file.path(arch_data,
                         "npk_vf_10_engrais.csv"))

npk$saison<-gsub(" ","_",tolower(npk$saison))
npk$culture_label<-gsub(" ","_",
                        tolower(npk$culture_label))

npk<-npk[-4]

npk<-na.omit(npk)

npk<-aggregate(npk["prix_kg_engrais"],
               FUN = sum,by = list(npk$producteur_ID,
                                   npk$saison,
                                   npk$culture_label))

names(npk)<-c("producteur_ID","saison",
              "culture_label","prix_kg_npk")

npk$culture_label<-gsub("carrotte","carotte",
                        npk$culture_label)

uree<-read.csv2(file.path(arch_data,
                          "uree_vf_10_engrais.csv"))

uree$saison<-gsub(" ","_",tolower(uree$saison))
uree$culture_label<-gsub(" ","_",
                         tolower(uree$culture_label))

uree<-uree[-4]

uree<-na.omit(uree)

uree<-aggregate(uree["prix_kg_engrais"],
                FUN = sum,by = list(uree$producteur_ID,
                                    uree$saison,
                                    uree$culture_label))

names(uree)<-c("producteur_ID","saison",
               "culture_label","prix_kg_uree")

uree$culture_label<-gsub("carrotte","carotte",
                         uree$culture_label)

engrais_org<-read.csv2(file.path(arch_data,
                                 "engrais_org_vf_10_engrais.csv"))

engrais_org$saison<-gsub(" ","_",tolower(engrais_org$saison))
engrais_org$culture_label<-gsub(" ","_",
                                tolower(engrais_org$culture_label))

engrais_org<-na.omit(engrais_org)

engrais_org<-aggregate(engrais_org[c("qte_kg_engrais",
                                     "prix_kg_engrais")],
                       FUN = sum,by = list(engrais_org$producteur_ID,
                                           engrais_org$saison,
                                           engrais_org$culture_label))

names(engrais_org)<-c("producteur_ID","saison",
                      "culture_label","qte_kg_engrais_org",
                      "prix_kg_engrais_org")

engrais_org$culture_label<-gsub("carrotte","carotte",
                                engrais_org$culture_label)

var<-c("producteur_ID","culture_label","saison",
       "qte_kg_insect","prix_insect","qte_kg_fong",
       "prix_fong","qte_kg_herb","prix_herb")

insecticide<-zap_labels(read_dta(file.path(arch_data,
                                           "vf_11_phyto.dta")))[var]

insecticide$saison<-gsub(" ","_",
                         tolower(insecticide$saison))

insecticide$culture_label<-gsub(" ","_",
                                tolower(insecticide$culture_label))

insecticide$culture_label<-gsub("carrotte","carotte",
                                insecticide$culture_label)

var<-c("producteur_ID","culture","saison",
       "charges_tot","charge_transport_semence",
       "charge_transport_engrais","autres_charges_intr")

charge<-zap_labels(read_dta(file.path(arch_data,
                                      "vf_12_autres_charges.dta")))[var]

charge<-aggregate(charge[c("charges_tot","charge_transport_semence",
                           "charge_transport_engrais",
                           "autres_charges_intr")],
                  FUN = sum,by = list(charge$producteur_ID,
                                      charge$saison,
                                      charge$culture))


names(charge)<-c("producteur_ID","culture_label","saison",
                 "charges_tot","charge_transport_semence",
                 "charge_transport_engrais","autres_charges_intr")

charge$saison<-gsub(" ","_",
                    tolower(charge$saison))

charge$culture_label<-gsub(" ","_",
                           tolower(charge$culture_label))

charge$culture_label<-gsub("carrotte","carotte",
                           charge$culture_label)

var<-c("producteur_ID","culture","saison",
       "prix_vente_indiv","quant_vend_indiv")

vente_ind<-zap_labels(read_dta(file.path(arch_data,
                                         "vf_14.1_vente.dta")))[var]

vente_ind<-aggregate(vente_ind[c("prix_vente_indiv",
                                 "quant_vend_indiv")],
                     FUN = mean,by = list(vente_ind$producteur_ID,
                                          vente_ind$saison,
                                          vente_ind$culture),
                     na.action = na.omit)

names(vente_ind)<-c("producteur_ID","culture_label",
                    "saison","prix_vente_indiv",
                    "quant_vend_indiv")

vente_ind$saison<-gsub(" ","_",
                       tolower(vente_ind$saison))

vente_ind$culture_label<-gsub(" ","_",
                              tolower(vente_ind$culture_label))

vente_ind$culture_label<-gsub("carrotte","carotte",
                              vente_ind$culture_label)

var<-c("producteur_ID","culture","saison",
       "prix_vente_indiv","quant_vend_indiv")

vente_ind<-zap_labels(read_dta(file.path(arch_data,
                                         "vf_14.1_vente.dta")))[var]

mean_prix<-aggregate(vente_ind[c("prix_vente_indiv")],FUN = mean,
                     by =list(vente_ind$culture),na.rm=TRUE)

write.csv2(vente_ind,file.path(getwd(),"price_culture.csv"))

var<-c("producteur_ID","culture_label","saison",
       "cout_sac","cout_for_sac","cout_transport",
       "cout_stockage","quant_stockage")

cout_com<-zap_labels(read_dta(file.path(arch_data,
                                        "vf_14.2_cout_commercialisation.dta")))[var]

cout_com<-aggregate(cout_com[c("cout_sac","cout_for_sac",
                               "cout_transport","cout_stockage",
                               "quant_stockage")],
                    FUN = sum,by = list(cout_com$producteur_ID,
                                        cout_com$saison,
                                        cout_com$culture_label))
names(cout_com)<-var

cout_com$saison<-gsub(" ","_",
                      tolower(cout_com$saison))

cout_com$culture_label<-gsub(" ","_",
                             tolower(cout_com$culture_label))

cout_com$culture_label<-gsub("carrotte","carotte",
                             cout_com$culture_label)

var<-c("producteur_ID","depense_achat")

cons_alim<-zap_labels(read_dta(file.path(arch_data,
                                         "vf_15.2_consommation_alimentaire.dta")))[var]

cons_alim<-na.omit(cons_alim)

cons_alim<-aggregate(cons_alim["depense_achat"],
                     FUN = sum,by = list(cons_alim$producteur_ID))

names(cons_alim)<-c("producteur_ID","depense_achat_alimen")

var<-c("producteur_ID","culture_label",
       "produits_non_alim","valeurestime_non_alim")

cons_non_alim<-zap_labels(read_dta(file.path(arch_data,
                                             "vf_15.3_consommation_non_alimentaire.dta")))[var]

cons_non_alim<-na.omit(cons_non_alim)

cons_non_alim<-aggregate(cons_non_alim["valeurestime_non_alim"],
                         FUN = sum,by = list(cons_non_alim$producteur_ID,
                                             cons_non_alim$culture_label))

names(cons_non_alim)<-c("producteur_ID","culture_label",
                        "estim_depense_non_alimen")

cons_non_alim$culture_label<-gsub(" ","_",
                                  tolower(cons_non_alim$culture_label))

cons_non_alim$culture_label<-gsub("carrotte","carotte",
                                  cons_non_alim$culture_label)

var<-c("producteur_ID","montant_elev")

revenu_elev<-zap_labels(read_dta(file.path(arch_data,
                                           "vf_19.1_autres_revenu_elevage.dta")))[var]

revenu_elev<-na.omit(revenu_elev)

revenu_elev<-aggregate(revenu_elev["montant_elev"],
                       FUN = sum,by = list(revenu_elev$producteur_ID))

names(revenu_elev)<-c("producteur_ID","rev_tot_elev")

var<-c("producteur_ID","montant_transfert")

revenu_migr<-zap_labels(read_dta(file.path(arch_data,
                                           "vf_19.2_autres_revenus_migration.dta")))[var]

revenu_migr<-na.omit(revenu_migr)

revenu_migr<-aggregate(revenu_migr["montant_transfert"],
                       FUN = sum,by = list(revenu_migr$producteur_ID))

names(revenu_migr)<-var

var<-c("producteur_ID","montant_rev_nonagri")

rev_non_agri<-zap_labels(read_dta(file.path(arch_data,
                                            "vf_19.3_autres_revenus_non_agri.dta")))[var]

rev_non_agri<-na.omit(rev_non_agri)

rev_non_agri<-aggregate(rev_non_agri["montant_rev_nonagri"],
                        FUN = sum,by = list(rev_non_agri$producteur_ID))

names(rev_non_agri)<-var

datt<-dplyr::left_join(datt,rendement_cult,c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,cout_semence,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,npk,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,uree,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,engrais_org,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,insecticide,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,charge,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,vente_ind,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,cout_com,by=c('producteur_ID',"culture_label","saison"))

datt<-dplyr::left_join(datt,cons_non_alim,by=c('producteur_ID',"culture_label"))

datt<-dplyr::left_join(datt,cout_electric,by='producteur_ID')
datt<-dplyr::left_join(datt,cons_alim,by='producteur_ID')
datt<-dplyr::left_join(datt,revenu_elev,by='producteur_ID')
datt<-dplyr::left_join(datt,revenu_migr,by='producteur_ID')
datt<-dplyr::left_join(datt,rev_non_agri,by='producteur_ID')  

write.csv2(datt,file.path(getwd(),"data_clust_rev.csv"))


pourc<- datt %>% 
  group_by(producteur_ID) %>%
  summarise(sup_emblavee_ha=(sup_emblavee_ha/
                               sum(sup_emblavee_ha))*100)

datt$sup_emblavee_ha<- pourc$sup_emblavee_ha#define quantiles of interest
q = seq(0, 1, by= 0.1)X<-datt[c("producteur_ID","saison","cluster","culture_label","capital")]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = quantile(capital, probs = q[1]),
    quant10 = quantile(capital, probs = q[2]), 
    quant20 = quantile(capital, probs = q[3]),
    quant30 = quantile(capital, probs = q[4]),
    quant40 = quantile(capital,probs = q[5]),
    quant50 = quantile(capital,probs = q[6]),
    quant60 = quantile(capital,probs = q[7]),
    quant70 = quantile(capital,probs = q[8]),
    quant80 = quantile(capital,probs = q[9]),
    quant90 = quantile(capital,probs = q[10]),
    max = quantile(capital, probs = q[11])
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","capital")]

#calculate quantiles by grouping variable
unique(X) %>%
  group_by(cluster) %>%
  summarize(
    min = quantile(capital, probs = q[1]),
    quant10 = quantile(capital, probs = q[2]), 
    quant20 = quantile(capital, probs = q[3]),
    quant30 = quantile(capital, probs = q[4]),
    quant40 = quantile(capital,probs = q[5]),
    quant50 = quantile(capital,probs = q[6]),
    quant60 = quantile(capital,probs = q[7]),
    quant70 = quantile(capital,probs = q[8]),
    quant80 = quantile(capital,probs = q[9]),
    quant90 = quantile(capital,probs = q[10]),
    max = quantile(capital, probs = q[11])
  )X<-data[c("id","capital")]
X$cluster<-k4$cluster

#calculate quantiles by grouping variable
unique(X) %>%
  group_by(cluster) %>%
  summarize(
    min = quantile(capital, probs = q[1]),
    quant10 = quantile(capital, probs = q[2]), 
    quant20 = quantile(capital, probs = q[3]),
    quant30 = quantile(capital, probs = q[4]),
    quant40 = quantile(capital,probs = q[5]),
    quant50 = quantile(capital,probs = q[6]),
    quant60 = quantile(capital,probs = q[7]),
    quant70 = quantile(capital,probs = q[8]),
    quant80 = quantile(capital,probs = q[9]),
    quant90 = quantile(capital,probs = q[10]),
    max = quantile(capital, probs = q[11])
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","Sup_emblavee_ha")]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = quantile(Sup_emblavee_ha, probs = q[1]),
    quant10 = quantile(Sup_emblavee_ha, probs = q[2]), 
    quant20 = quantile(Sup_emblavee_ha, probs = q[3]),
    quant30 = quantile(Sup_emblavee_ha, probs = q[4]),
    quant40 = quantile(Sup_emblavee_ha,probs = q[5]),
    quant50 = quantile(Sup_emblavee_ha,probs = q[6]),
    quant60 = quantile(Sup_emblavee_ha,probs = q[7]),
    quant70 = quantile(Sup_emblavee_ha,probs = q[8]),
    quant80 = quantile(Sup_emblavee_ha,probs = q[9]),
    quant90 = quantile(Sup_emblavee_ha,probs = q[10]),
    max = quantile(Sup_emblavee_ha, probs = q[11])
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","Sup_emblavee_ha")]
P<- X %>% 
  group_by(producteur_ID) %>%
  summarise(Sup_emblavee_ha=(Sup_emblavee_ha/
                               sum(Sup_emblavee_ha))*100)

X$Sup_emblavee_ha<-P$Sup_emblavee_ha


#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = round(quantile(Sup_emblavee_ha, 
                         probs = q[1]),2),
    quant10 = round(quantile(Sup_emblavee_ha, 
                             probs = q[2]),2), 
    quant20 = round(quantile(Sup_emblavee_ha,
                             probs = q[3]),2),
    quant30 = round(quantile(Sup_emblavee_ha, 
                             probs = q[4]),2),
    quant40 = round(quantile(Sup_emblavee_ha,
                             probs = q[5]),2),
    quant50 = round(quantile(Sup_emblavee_ha,
                             probs = q[6]),2),
    quant60 = round(quantile(Sup_emblavee_ha,
                             probs = q[7]),2),
    quant70 = round(quantile(Sup_emblavee_ha,
                             probs = q[8]),2),
    quant80 = round(quantile(Sup_emblavee_ha,
                             probs = q[9]),2),
    quant90 = round(quantile(Sup_emblavee_ha,
                             probs = q[10]),2),
    max = round(quantile(Sup_emblavee_ha,
                         probs = q[11]),2)
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","quant_semence_kg")]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = round(quantile(quant_semence_kg, 
                         probs = q[1]),2),
    quant10 = round(quantile(quant_semence_kg, 
                             probs = q[2]),2), 
    quant20 = round(quantile(quant_semence_kg,
                             probs = q[3]),2),
    quant30 = round(quantile(quant_semence_kg, 
                             probs = q[4]),2),
    quant40 = round(quantile(quant_semence_kg,
                             probs = q[5]),2),
    quant50 = round(quantile(quant_semence_kg,
                             probs = q[6]),2),
    quant60 = round(quantile(quant_semence_kg,
                             probs = q[7]),2),
    quant70 = round(quantile(quant_semence_kg,
                             probs = q[8]),2),
    quant80 = round(quantile(quant_semence_kg,
                             probs = q[9]),2),
    quant90 = round(quantile(quant_semence_kg,
                             probs = q[10]),2),
    max = round(quantile(quant_semence_kg,
                         probs = q[11]),2)
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","quant_uree_kg")]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = round(quantile(quant_uree_kg, 
                         probs = q[1]),2),
    quant10 = round(quantile(quant_uree_kg, 
                             probs = q[2]),2), 
    quant20 = round(quantile(quant_uree_kg,
                             probs = q[3]),2),
    quant30 = round(quantile(quant_uree_kg, 
                             probs = q[4]),2),
    quant40 = round(quantile(quant_uree_kg,
                             probs = q[5]),2),
    quant50 = round(quantile(quant_uree_kg,
                             probs = q[6]),2),
    quant60 = round(quantile(quant_uree_kg,
                             probs = q[7]),2),
    quant70 = round(quantile(quant_uree_kg,
                             probs = q[8]),2),
    quant80 = round(quantile(quant_uree_kg,
                             probs = q[9]),2),
    quant90 = round(quantile(quant_uree_kg,
                             probs = q[10]),2),
    max = round(quantile(quant_uree_kg,
                         probs = q[11]),2)
  )

X<-datt[c("producteur_ID","saison","cluster","culture_label","quant_npk_kg")]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = round(quantile(quant_npk_kg, 
                         probs = q[1]),2),
    quant10 = round(quantile(quant_npk_kg, 
                             probs = q[2]),2), 
    quant20 = round(quantile(quant_npk_kg,
                             probs = q[3]),2),
    quant30 = round(quantile(quant_npk_kg, 
                             probs = q[4]),2),
    quant40 = round(quantile(quant_npk_kg,
                             probs = q[5]),2),
    quant50 = round(quantile(quant_npk_kg,
                             probs = q[6]),2),
    quant60 = round(quantile(quant_npk_kg,
                             probs = q[7]),2),
    quant70 = round(quantile(quant_npk_kg,
                             probs = q[8]),2),
    quant80 = round(quantile(quant_npk_kg,
                             probs = q[9]),2),
    quant90 = round(quantile(quant_npk_kg,
                             probs = q[10]),2),
    max = round(quantile(quant_npk_kg,
                         probs = q[11]),2)
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","quant_eau_csc")]
X<-X[which(X$saison=="CSC"),]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = round(quantile(quant_eau_csc, 
                         probs = q[1]),2),
    quant10 = round(quantile(quant_eau_csc, 
                             probs = q[2]),2), 
    quant20 = round(quantile(quant_eau_csc,
                             probs = q[3]),2),
    quant30 = round(quantile(quant_eau_csc, 
                             probs = q[4]),2),
    quant40 = round(quantile(quant_eau_csc,
                             probs = q[5]),2),
    quant50 = round(quantile(quant_eau_csc,
                             probs = q[6]),2),
    quant60 = round(quantile(quant_eau_csc,
                             probs = q[7]),2),
    quant70 = round(quantile(quant_eau_csc,
                             probs = q[8]),2),
    quant80 = round(quantile(quant_eau_csc,
                             probs = q[9]),2),
    quant90 = round(quantile(quant_eau_csc,
                             probs = q[10]),2),
    max = round(quantile(quant_eau_csc,
                         probs = q[11]),2)
  )X<-datt[c("producteur_ID","saison","cluster","culture_label","quant_eau_csf")]
X<-X[which(X$saison=="CSF"),]

#calculate quantiles by grouping variable
X %>%
  group_by(saison,cluster,culture_label) %>%
  summarize(
    min = round(quantile(quant_eau_csf, 
                         probs = q[1]),2),
    quant10 = round(quantile(quant_eau_csf, 
                             probs = q[2]),2), 
    quant20 = round(quantile(quant_eau_csf,
                             probs = q[3]),2),
    quant30 = round(quantile(quant_eau_csf, 
                             probs = q[4]),2),
    quant40 = round(quantile(quant_eau_csf,
                             probs = q[5]),2),
    quant50 = round(quantile(quant_eau_csf,
                             probs = q[6]),2),
    quant60 = round(quantile(quant_eau_csf,
                             probs = q[7]),2),
    quant70 = round(quantile(quant_eau_csf,
                             probs = q[8]),2),
    quant80 = round(quantile(quant_eau_csf,
                             probs = q[9]),2),
    quant90 = round(quantile(quant_eau_csf,
                             probs = q[10]),2),
    max = round(quantile(quant_eau_csf,
                         probs = q[11]),2)
  )X<-datt[c("producteur_ID","saison","cluster",
             "culture_label","Sup_emblavee_ha",
             "quant_semence_kg","quant_uree_kg",
             "quant_npk_kg","quant_eau_csc",
             "quant_eau_csf")]
Y<-c("Sup_emblavee_ha","quant_semence_kg",
     "quant_uree_kg","quant_npk_kg",
     "quant_eau_csc","quant_eau_csf")

X$Sup_emblavee_ha<-P$Sup_emblavee_ha
X[Y]<-round(X[Y],2)


parangon<-X[which(X$producteur_ID%in%row.names(para)),]
parangon
C<-dplyr::left_join(data[c("id","capital")],
                    var_clt4["cluster"] %>%
                      mutate(id = 
                               (rownames(var_clt4["cluster"]))),
                    by = 'id')


C[which(C$id%in%row.names(para)),]

